rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is the owner of the document.
    // This is the core security principle of the app.
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    //-------------------------------------------------------------------------
    // User Profiles
    // - A user can create, read, update, and delete their own profile.
    // - No user can list all other users.
    //-------------------------------------------------------------------------
    match /users/{userId} {
      allow read, update, delete: if isOwner(userId);
      allow create: if request.auth != null;
    }

    //-------------------------------------------------------------------------
    // Sub-collections under a User
    // The following match groups ensure that all operations on a user's
    // sub-collections are only performed by the owner of that data.
    //-------------------------------------------------------------------------

    // Patients Collection
    match /users/{userId}/patients/{patientId} {
      allow read, write: if isOwner(userId);
    }

    // Appointments Sub-collection (nested under patients)
    match /users/{userId}/patients/{patientId}/appointments/{appointmentId} {
      allow read, write: if isOwner(userId);
    }

    // Message Templates Collection
    match /users/{userId}/messageTemplates/{templateId} {
      allow read, write: if isOwner(userId);
    }

    // Scheduled Messages Collection
    match /users/{userId}/scheduledMessages/{messageId} {
      allow read, write: if isOwner(userId);
    }

    // Workflows Collection
    match /users/{userId}/workflows/{workflowId} {
      allow read, write: if isOwner(userId);
    }
  }
}
